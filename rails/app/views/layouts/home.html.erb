<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
       "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<title>Stations: <%= controller.action_name %></title>
	<%= stylesheet_link_tag 'scaffold' %>
	<style type="text/css">
		html { height: 100% }
		body { height: 100%; margin: 0px; padding: 0px }
		#map_canvas { height: 100% }
	</style>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<%= javascript_include_tag 'maps' %>
	<script>
function initialize()
{
	var mylatlng = new google.maps.LatLng(<%= SCAN_CONFIG['latitude'] %>, <%= SCAN_CONFIG['longitude'] %>);
	var centerlatlng = new google.maps.LatLng(<%= @map_location['latitude'] %>, <%= @map_location['longitude'] %>);
	var myOptions =
	{
		zoom: <%= @zoom %>,
		center: centerlatlng,
		disableDefaultUI: true,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

	google.maps.event.addListener(map, 'click', function() {
		clearActive();
		clearMoved();
	});

	google.maps.event.addListener(map, 'zoom_changed', function() {
		document.getElementById('zoom').value = map.getZoom();
	});

	google.maps.event.addListener(map, 'center_changed', function() {
		var center = map.getCenter();

		document.getElementById('location_latitude').value = center.lat();
		document.getElementById('location_longitude').value = center.lng();
	});

	google.maps.event.addListener(map, 'zoom_changed', function() {
		var zoom = map.getZoom();
		if(zoom < 8) map.setZoom(8);
	});

<% i=0 %>
<% @logs.each do |log| %>
<% station = log.station %>
<%
	def get_marker_image(ss)
		if ss > 70
			return "http://maps.gstatic.com/intl/en_us/mapfiles/ms/micons/green-dot.png";
		elsif ss > 50
			return "http://maps.gstatic.com/intl/en_us/mapfiles/ms/micons/yellow-dot.png";
		else
			return "http://maps.gstatic.com/intl/en_us/mapfiles/ms/micons/red-dot.png";
		end
	end
%>

markers[<%= i %>] = new google.maps.Marker(
{
	position: new google.maps.LatLng(<%= station.latitude %>, <%= station.longitude %>),
	map: map,
	draggable: false,
	clickable: true,
	title:'<%= station.callsign %>',
	zIndex: 0,
	icon: '<%= get_marker_image(log.signal_strength) %>'
});

infowindows[<%= i %>] = new google.maps.InfoWindow({
	content: '<%= station.callsign %><br />' +
	'<hr>' +
	'Last received on <br />' +
	'Channel: <%= station.rf %><br />' +
	'Distance: <%= station.distance %> miles<br />' +
	'Most recent scan:<br />' +
	'Signal Strength: <%= log.signal_strength %><br />' +
	'Signal Quality: <%= log.signal_to_noise %><br />' +
	'Symbol Quality: <%= log.signal_quality %><br />' +
	'<br />' +
// 	'<a href=\"plot.php?id=$id&tuner={$tuner->id}\" target=\"_blank\">Signal Graph</a><br />' +
	'<a href=\"http://rabbitears.info/market.php?request=station_search&callsign=<%= station.callsign %>#station\" target=\"_blank\">RabbitEars lookup</a>'
});

markers[<%= i %>].click = function()
{
	// 	map.setCenter(new google.maps.LatLng($latitude, $longitude));
	clearActive();
	active=<%= i %>
	checkMove();
	markers[<%= i %>].setZIndex(2);
	infowindows[<%= i %>].open(map, markers[<%= i %>]);
};

google.maps.event.addListener(markers[<%= i %>], 'click', markers[<%= i %>].click);

addPoint(markers[<%= i %>]);
<% i += 1 %>
<% end %>
}
</script>
</head>
<body onload='initialize()'>

<p style="color: green"><%= notice %></p>

<%= yield %>

</body>
</html>
